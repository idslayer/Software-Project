<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Verification</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 40px;
    }
    .container {
      max-width: 1200px;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
    }
    .result {
      margin-top: 20px;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    .success {
      background: #e8f5e9;
      color: #388e3c;
      border: 1px solid #c8e6c9;
    }
    .error {
      background: #ffebee;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }
    hr {
      margin: 30px 0;
    }
    table {
      width: 100%;
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4">Verify Log Integrity</h2>

  <!-- Verify Section -->
  <form class="row g-3 align-items-center mb-4" onsubmit="event.preventDefault(); verifyLog();">
    <div class="col-md-8">
      <input type="text" id="recordId" class="form-control" placeholder="Enter record_id or hash_hex">
    </div>
    <div class="col-md-4 d-grid">
      <button id="verifyBtn" type="submit" class="btn btn-primary">Verify</button>
    </div>
  </form>
  <div id="result" class="result" style="display:none;"></div>

  <hr>

  <!-- Search Section -->
  <h3 class="mb-3">Search Logs</h3>
  <form id="searchForm" class="row g-3 mb-4" onsubmit="searchLogs(event)">
    <div class="col-md-2">
      <input type="text" id="searchHash" class="form-control" placeholder="Hash">
    </div>
    <div class="col-md-3">
      <input type="text" id="searchMessage" class="form-control" placeholder="Message">
    </div>
    <div class="col-md-2">
      <input type="date" id="searchStart" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" id="searchEnd" class="form-control">
    </div>
    <div class="col-md-3 d-grid">
      <button type="submit" class="btn btn-success">Search</button>
    </div>
  </form>

  <div id="searchResult" style="margin-top:18px;"></div>
  <div class="d-flex justify-content-between align-items-center mt-3" id="pagingControls" style="display:none;">
    <button class="btn btn-secondary" id="prevPageBtn" onclick="changePage(-1)">Prev</button>
    <span id="currentPageLabel">Page 1</span>
    <button class="btn btn-secondary" id="nextPageBtn" onclick="changePage(1)">Next</button>
  </div>
</div>

<script>
  async function verifyLog() {
    const recordId = document.getElementById('recordId').value.trim();
    const resultDiv = document.getElementById('result');
    const verifyBtn = document.getElementById('verifyBtn');

    if (!recordId) {
      alert('Please enter a record ID or hash.');
      return;
    }

    verifyBtn.disabled = true;
    resultDiv.style.display = 'none';
    resultDiv.className = 'result';
    resultDiv.textContent = '';

    try {
      const response = await fetch(`/verifier/verify?logHash=${encodeURIComponent(recordId)}`);
      const data = await response.json();

      if (response.ok && data.valid) {
        resultDiv.classList.add('success');
        let table = '<table class="table table-bordered table-striped"><tbody>';
        for (const [key, value] of Object.entries(data)) {
          table += `<tr><th>${key}</th><td>${value}</td></tr>`;
        }
        table += '</tbody></table>';
        resultDiv.innerHTML = `✅ Verified: Record is valid.<br>${table}`;
      } else {
        resultDiv.classList.add('error');
        resultDiv.textContent = `❌ Verification failed: ${data.message || 'Record not found or invalid'}`;
      }
    } catch (error) {
      resultDiv.classList.add('error');
      resultDiv.textContent = `❌ API Error: ${error.message}`;
    } finally {
      resultDiv.style.display = 'block';
      verifyBtn.disabled = false;
    }
  }

  let currentPage = 0;
  const pageSize = 10;
  let lastResultCount = 0;

  async function searchLogs(event, pageDelta = 0) {
    if (event) event.preventDefault();
    currentPage += pageDelta;
    if (currentPage < 0) currentPage = 0;
    const hash = document.getElementById('searchHash').value.trim();
    const message = document.getElementById('searchMessage').value.trim();
    const startDate = document.getElementById('searchStart').value;
    const endDate = document.getElementById('searchEnd').value;
    const searchResultDiv = document.getElementById('searchResult');
    const pagingControls = document.getElementById('pagingControls');
    const currentPageLabel = document.getElementById('currentPageLabel');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    searchResultDiv.innerHTML = '';

    if (!startDate || !endDate) {
      searchResultDiv.innerHTML = '<div class="error">Start and End dates are required.</div>';
      pagingControls.style.display = 'none';
      return;
    }

    const startTsMillis = new Date(startDate).getTime();
    const endTsMillis = new Date(endDate).getTime();

    try {
      const params = new URLSearchParams({ hash, message, startTsMillis, endTsMillis, page: currentPage, size: pageSize });
      const response = await fetch(`/verifier/searchLogs?${params.toString()}`);
      const data = await response.json();
      lastResultCount = Array.isArray(data) ? data.length : 0;

      if (lastResultCount > 0) {
        let table = '<table class="table table-bordered table-striped">';
        table += '<thead><tr><th>Timestamp</th><th>Hash</th><th>Message</th></tr></thead><tbody>';
        data.forEach(log => {
          table += `<tr><td>${log.timestamp}</td><td>${log.hash}</td><td>${log.message}</td></tr>`;
        });
        table += '</tbody></table>';
        searchResultDiv.innerHTML = table;
        pagingControls.style.display = 'flex';
        currentPageLabel.textContent = `Page ${currentPage + 1}`;
        prevPageBtn.disabled = currentPage === 0;
        nextPageBtn.disabled = lastResultCount < pageSize;
      } else {
        searchResultDiv.innerHTML = '<div class="error">No logs found.</div>';
        pagingControls.style.display = currentPage > 0 ? 'flex' : 'none';
        nextPageBtn.disabled = true;
      }
    } catch (error) {
      searchResultDiv.innerHTML = `<div class="error">API Error: ${error.message}</div>`;
      pagingControls.style.display = 'none';
    }
  }

  function changePage(delta) {
    searchLogs(null, delta);
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
